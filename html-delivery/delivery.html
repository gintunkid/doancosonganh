<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao hàng</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/home.html">
    <script src="/js/checklogin.js"></script>
    <script type="module" src="/js/firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script type="module" src="/js/delivery.js"></script>
</head>
<body>
    <section class="top">
        <div class="container">
            <div class="row">
                <div class="top-logo">
                    <img src="/img/logo.png" alt="">
                </div>
                <div class="top-menu-items">
                    <ul>
                        <li><a href="/home.html">Home</a></li>
                        <li>
                            Nike
                            <ul class="top-menu-item">
                                <li><a href="/html-cartegory/nikenam.html">Nam</a></li>
                                <li><a href="/html-cartegory/nikenu.html">Nữ</a></li>
                            </ul>
                        </li>
                        <li>
                            Adidas
                            <ul class="top-menu-item">
                                <li><a href="/html-cartegory/adidasnam.html">Nam</a></li>
                                <li><a href="/html-cartegory/adidasnu.html">Nữ</a></li>
                            </ul>
                        </li>
                        <li>
                            Other-Brand
                            <ul class="top-menu-item">
                                <li><a href="/html-cartegory/daygiay.html">Dây giày</a></li>
                                <li><a href="/html-cartegory/vesinhgiay.html">Crep Protect - Vệ sinh giày</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="top-menu-icons">
                    <ul>
                        <li>
                            <div class="search-bar" style="display: none;">
                                <input type="text" id="searchInput" placeholder="Nhập từ cần tìm">
                                <button id="searchButton" class="fas fa-search"></button>
                            </div>
                        </li>
                        <li><a href="/login-admin/login.html"><i class="fa-regular fa-user"></i></a></li>
                        <li><a href="/html-cart/cart.html"><i id="cart-icon"class="fas fa-shopping-cart"></i></a><span id="cart-count">0</span></li>                    
                    </ul>
                </div>
            </div>
        </div>
    </section>
    
<!------------------ PRODUCT------------------->
<section class="delivery">
    <div class="container">
        <div class="delivery-top-wrap">
            <div class="delivery-top">
                <div class="delivery-top-delivery delivery-top-item">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="delivery-top-adress delivery-top-item">
                    <i class="fa-solid fa-location-dot"></i>
                </div>
            </div>
        </div>
    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1234.2803988661708!2d106.65824843418264!3d10.8421925823672!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x317529a39923b7b1%3A0x22b8d99345c4a4d4!2zMjAwIMSQLiBMw6ogVsSDbiBUaOG7jSwgUGjGsOG7nW5nIDExLCBHw7IgVuG6pXAsIEjhu5MgQ2jDrSBNaW5oLCBWaWV0bmFt!5e0!3m2!1sen!2s!4v1740529750346!5m2!1sen!2s" width="1200" height="400" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>    </div>
    <div class="container">
        <div class="delivery-content row">
            <div class="delivery-content-left">
                <p>Vui lòng chọn địa chỉ giao hàng <span style="color: red;">*</span></p>
                <p>Qua Fanpage <a href="https://www.facebook.com/profile.php?id=61569810176348" target="_blank">Step Up Store</a> của shop để đặt hàng</p>
                <div class="delivery-content-left-input-top row">
                    <div class="delivery-content-left-input-top-item">
                        <label for="fullName">Họ tên <span style="color: red;">*</span></label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="delivery-content-left-input-top-item">
                        <label for="phone">Điện thoại <span style="color: red;">*</span></label>
                        <input type="text" id="phone" name="phone" required>
                    </div>  
                    <div class="delivery-content-left-input-top-item">
                        <label for="provinceDropdown">Tỉnh/tp <span style="color: red;">*</span></label>
                        <select id="provinceDropdown" class="select" aria-readonly="">
                            <option value="">TP Hồ Chí Minh</option>
                        </select>
                    </div>
                    <div class="delivery-content-left-input-top-item">
                        <label for="districtDropdown">Quận/huyện <span style="color: red;">*</span></label>
                        <select id="districtDropdown" class="select" required>
                            <option value="">--Chọn quận/huyện--</option>
                            <option value="Quận 1">Quận 1</option>
                            <option value="Quận 2">Quận 2</option>
                            <option value="Quận 3">Quận 3</option>
                            <option value="Quận 4">Quận 4</option>
                            <option value="Quận 5">Quận 5</option>
                            <option value="Quận 6">Quận 6</option>
                            <option value="Quận 7">Quận 7</option>
                            <option value="Quận 8">Quận 8</option>
                            <option value="Quận 9">Quận 9</option>
                            <option value="Quận 10">Quận 10</option>
                            <option value="Quận 11">Quận 11</option>
                            <option value="Quận 12">Quận 12</option>
                            <option value="Quận Bình Thạnh">Quận Bình Thạnh</option>
                            <option value="Quận Gò Vấp">Quận Gò Vấp</option>
                            <option value="Quận Tân Phú">Quận Tân Phú</option>
                            <option value="Quận Tân Bình">Quận Tân Bình</option>
                            <option value="Quận Phú Nhuận">Quận Phú Nhuận</option>
                            <option value="Quận Bình Tân">Quận Bình Tân</option>
                            <option value="Quận Thủ Đức">Quận Thủ Đức</option>
                            <option value="Huyện Bình Chánh">Huyện Bình Chánh</option>
                            <option value="Huyện Hóc Môn">Huyện Hóc Môn</option>
                            <option value="Huyện Củ Chi">Huyện Củ Chi</option>
                            <option value="Huyện Cần Giờ">Huyện Cần Giờ</option>
                            <option value="Huyện Nhà Bè">Huyện Nhà Bè</option>
                        </select>
                    </div>
                    <div class="delivery-content-left-input-top-item">
                        <label for="wardInput">Phường/Xã/Thị trấn<span style="color: red;">*</span></label>
                        <input type="text" id="wardInput" name="wardInput" required>
                    </div> 
                    <div class="delivery-content-left-input-top-item">
                        <label for="addressInput">Địa chỉ <span style="color: red;">*</span></label>
                        <input type="text" id="addressInput" name="addressInput" required>
                    </div>                                                                                           
                    <div class="delivery-content-left-button row">
                        <button style="align-items: center;"><span>&#171;</span><p style="font-weight: bold;"><a href="/html-cart/cart.html">QUAY LẠI GIỎ HÀNG</a></p></button>
                        <button onclick="submitOrder(event)"><p style="font-weight: bold;">THANH TOÁN VÀ GIAO HÀNG</p></button>
                    </div>
                    <div class="" style="display: flex; align-items: center; float: left; margin-top: 0; margin-bottom: 0; padding-top:10px">
                        <input type="radio" id="payment" name="payment" checked disabled>
                        <label for="payment" style="margin: 0;padding-left:5px">Thanh toán khi nhận hàng</label>
                    </div>
                </div>                                
            </div>       
                <div class="delivery-content-right">
                    <table id="cart-table">
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Thành tiền</th>
                        </tr>
                        <tr>
                            <td id="total-quantity"></td>
                            <td id="total-price"></td>
                            <td id="subtotal-price"><p>... <sup>đ</sup></p></td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold;" colspan="3">Tổng</td>
                            <td id="subtotal-price" style="font-weight: bold;"><p>0 <sup>đ</sup></p></td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold;" id="shipping-fee" colspan="3">Phí ship</td>
                            <td style="font-weight: bold;"><p id="shipping-fee-value">0 <sup>đ</sup></p></td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold;" colspan="3">Tổng tiền hàng</td>
                            <td id="total-amount" style="font-weight: bold;"><p>0 <sup>đ</sup></p></td>
                        </tr>
                    </table> 
                </div>
        </div>
    </div>
</section>

<!-------------------- footer --------------------->
<section class="footer">
    <div class="footer-container">
        <p>Truy cập Fanpage <a href="https://www.facebook.com/profile.php?id=61569810176348" target="_blank">Step - Up</a></p>
        <div class="app-google">
            <a href="https://www.apple.com/app-store/" target="_blank"><img src="/img/Screenshot 2024-05-15 003849.png" alt=""></a>
            <a href="https://play.google.com/store/games?hl=vi&pli=1" target="_blank"><img src="/img/Screenshot 2024-05-15 003813.png" alt=""></a>
        </div>
        <div class="footer-items">
            <li><a href="http://online.gov.vn" target="_blank"><img src="/img/Screenshot 2024-05-15 003506.png" alt="" ></a></li>
            <li><a href="tel:0797268602">Liên hệ</a></li>
            <li><a href="">Giới thiệu</a></li>
            <li><a href="https://www.facebook.com/profile.php?id=61569810176348" target="_blank"><i class="fab fa-facebook-f"></i></a><a href="https://mail.google.com/mail/?view=cm&fs=1&to=nguyentuankiet160804@gmail.com" target="_blank"><i class="fa-solid fa-envelope"></i></a></li>
        </div>
        <div class="footer-text">
            <p></p>
            Địa chỉ đăng ký: 254/5, đường Lê Văn Thọ, phường 11, quận Gò Vấp
            Đặt hàng online: 0797268602
        </div>
        <div class="footer-bottom">
            Copyright © 2025 Step - Up Studio. Powered by BOYS
        </div>
    </div>
</section>
<script src="/js/function.js"></script>
<script type="module">
    import { displayCart, updateQuantity, removeItem } from '/js/cart.js';
    window.updateQuantity = updateQuantity;
    window.removeItem = removeItem;
    //Hello
</script>
<!----------------------------------- Hàm thêm các tỉnh/thành;quận/huyện từ API của GHN ---------------------------->
<script>
    // Hàm tải danh sách tỉnh/thành
    async function loadProvinces() {
        try {   
            const response = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Token": "66ce5502-9c0f-11ef-8693-5abc7748e730" // API_Key 
                }
            });
            const data = await response.json();
            
            if (data.code === 200) {
                const provinces = data.data;
                const provinceDropdown = document.getElementById("provinceDropdown");
                
                provinces.forEach(province => {
                    const option = document.createElement("option");
                    option.value = province.ProvinceID;
                    option.text = province.ProvinceName;
                    provinceDropdown.add(option);
                });
            } else {
                console.error("Không thể tải danh sách tỉnh thành", data.message);
            }
        } catch (error) {
            console.error("Lỗi khi gọi API", error);
        }
    }

    // Hàm tải danh sách quận/huyện dựa vào tỉnh/thành đã chọn
    async function loadDistricts(provinceID) {
        try {
            const response = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/district", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Token": "66ce5502-9c0f-11ef-8693-5abc7748e730" // Thay YOUR_API_KEY bằng API Key của bạn
                },
                body: JSON.stringify({ province_id: parseInt(provinceID) })
            });
            const data = await response.json();
            
            if (data.code === 200) {
                const districts = data.data;
                const districtDropdown = document.getElementById("districtDropdown");
                districtDropdown.innerHTML = '<option value="">--Chọn quận/huyện--</option>';
                
                districts.forEach(district => {
                    const option = document.createElement("option");
                    option.value = district.DistrictID;
                    option.text = district.DistrictName;
                    districtDropdown.add(option);
                });
            } else {
                console.error("Không thể tải danh sách quận/huyện:", data.message);
            }
        } catch (error) {
            console.error("Lỗi khi gọi API", error);
        }
    }
    // Gọi hàm loadProvinces khi trang được tải
    document.addEventListener("DOMContentLoaded", loadProvinces);

    // Lắng nghe sự kiện khi người dùng chọn tỉnh/thành để tải quận/huyện
    document.getElementById("provinceDropdown").addEventListener("change", function() {
        const provinceID = this.value;
        if (provinceID) {
            loadDistricts(provinceID);
        } else {
            document.getElementById("district").innerHTML = '<option value="">--Chọn quận/huyện--</option>';
        }
    });
// Khởi tạo Firebase (Đảm bảo đã cấu hình Firebase chính xác)
import { auth,db } from './firebase-config.js';

// Lấy giỏ hàng từ localStorage
function getCart() {
    return JSON.parse(localStorage.getItem('cart')) || [];
}

// Cập nhật bảng giỏ hàng với các sản phẩm
async function updateCartTable() {
    const cart = getCart();
    const cartTable = document.getElementById('cart-table');
    let total = 0;
    let totalQuantity = 0;

    // Xóa các hàng cũ trong bảng
    const rows = cartTable.querySelectorAll('tr');
    rows.forEach((row, index) => {
        if (index > 0) row.remove(); // Bỏ qua dòng tiêu đề
    });

    // Lặp qua các sản phẩm trong giỏ hàng và thêm vào bảng
    for (const item of cart) {
        try {
            // Lấy thông tin sản phẩm từ Firebase
            const docRef = db.collection("products").doc(item.id);
            const doc = await docRef.get();

            if (doc.exists) {
                const product = doc.data();
                const subtotal = product.price * item.quantity; // Tính tiền cho sản phẩm

                // Cập nhật tổng số tiền và số lượng
                total += subtotal;
                totalQuantity += item.quantity;

                // Thêm dòng mới vào bảng
                const row = `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.discount ? `-${product.discount}%` : 'Không có'}</td>
                        <td>${item.quantity}</td>
                        <td>${subtotal.toLocaleString('vi-VN')}đ</td>
                    </tr>
                `;
                cartTable.innerHTML += row;
            }
        } catch (error) {
            console.error("Error loading product data:", error);
        }
    }

    // Cập nhật tổng số tiền và số lượng
    document.getElementById('total-quantity').textContent = totalQuantity;
    document.getElementById('total-price').textContent = `${total.toLocaleString('vi-VN')}đ`;
    document.getElementById('subtotal-price').textContent = `${total.toLocaleString('vi-VN')}đ`;
}

// Khởi động khi trang tải
document.addEventListener('DOMContentLoaded', updateCartTable);

// Hiển thị giỏ hàng
async function displayCart() {
    try {   
        const cart = getCart();
        const cartContent = document.querySelector('.cart-content-left table tbody');
        const totalQuantityElement = document.getElementById('total-quantity');
        const totalPriceElement = document.getElementById('total-price');
        const subtotalPriceElement = document.getElementById('subtotal-price');

        if (!cartContent) return;
        cartContent.innerHTML = '';

        let total = 0;
        let totalItems = 0;

        for (const item of cart) {
            try {
                const docRef = db.collection("products").doc("nike").collection("nike_nu").doc(item.id);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const product = doc.data();
                    const subtotal = product.price * item.quantity;
                    total += subtotal;
                    totalItems += item.quantity;

                    const row = `
                        <tr>
                            <td><img src="${product.imageURL}" alt="${product.name}"></td>
                            <td><p>${product.name}</p></td>
                            <td>
                                <div class="quantity-controls">

                                    <input type="number" value="${item.quantity}" min="1" 
                                           onchange="updateQuantity('${item.id}', this.value)">
                                </div>
                            </td>
                            <td><p>${subtotal.toLocaleString('vi-VN')}đ</p></td>
                            <td><button onclick="removeItem('${item.id}')" class="remove-btn">Xóa</button></td>
                        </tr>
                    `;
                    cartContent.innerHTML += row;
                }
            } catch (error) {
                console.error("Error loading product:", error);
            }
        }
    } catch (error) {
        console.error("Error displaying cart:", error);
    }
}

</script>
</body>
</html>